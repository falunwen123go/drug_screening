# 🔬 药物筛选系统 - 操作指南

## 目录
1. [系统概述](#1-系统概述)
2. [环境配置与启动](#2-环境配置与启动)
3. [功能模块详解](#3-功能模块详解)
   - [单分子预测](#31-单分子预测)
   - [批量筛选](#32-批量筛选)
4. [API 接口说明](#4-api-接口说明)
5. [常见问题与解决方案](#5-常见问题与解决方案)

---

## 1. 系统概述

本系统是一个基于深度学习的药物虚拟筛选平台，采用现代化的前后端分离架构：

| 组件 | 技术栈 | 端口 |
|------|--------|------|
| 前端 | Vue 3 + TypeScript + TailwindCSS + Vite | 5173 |
| 后端 | FastAPI + PyTorch + RDKit | 8000 |
| 模型 | DrugPredictorMLPv2 (1024→256→128→64→1) | - |

### 核心功能
- ✅ **单分子活性预测**：输入SMILES，预测药物活性分数
- ✅ **批量虚拟筛选**：上传化合物库CSV，筛选Top-K候选
- ✅ **分子属性计算**：MW、LogP、TPSA、HBD、HBA等
- ✅ **Lipinski规则评估**：自动判断成药性五规则
- ✅ **分子结构可视化**：2D分子结构图生成

---

## 2. 环境配置与启动

### 2.1 启动后端服务

```bash
# 进入项目根目录
cd d:\OneDrive\桌面\cursor\drug

# 激活Python环境（如使用conda）
conda activate drug_screening  # 或你的环境名

# 启动FastAPI后端
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**启动成功标志**：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Successfully loaded model: DrugPredictorMLPv2
```

### 2.2 启动前端服务

打开新的终端窗口：

```bash
# 进入前端目录
cd d:\OneDrive\桌面\cursor\drug\frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

**启动成功标志**：
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

### 2.3 访问系统

打开浏览器访问：**http://localhost:5173**

---

## 3. 功能模块详解

### 3.1 单分子预测

**功能路径**：首页 → 单分子预测

#### 操作步骤

1. **输入SMILES**
   - 在输入框中输入分子的SMILES字符串
   - 或点击下拉菜单选择预置示例分子：
     | 药物名称 | SMILES |
     |----------|--------|
     | 阿司匹林 | `CC(=O)OC1=CC=CC=C1C(=O)O` |
     | 咖啡因 | `CN1C=NC2=C1C(=O)N(C(=O)N2C)C` |
     | 布洛芬 | `CC(C)CC1=CC=C(C=C1)C(C)C(=O)O` |
     | 对乙酰氨基酚 | `CC(=O)NC1=CC=C(C=C1)O` |
     | 青霉素G | `CC1(C(N2C(S1)C(C2=O)NC(=O)CC3=CC=CC=C3)C(=O)O)C` |
     | 氯霉素 | `C1=CC(=CC=C1C(C(CO)NC(=O)C(Cl)Cl)O)[N+](=O)[O-]` |

2. **点击预测按钮**
   - 点击「🔮 开始预测」按钮
   - 等待预测完成（约1-2秒）

3. **查看预测结果**
   
   结果分为多个部分：

   | 区域 | 内容说明 |
   |------|----------|
   | 分子结构图 | 显示分子2D结构 |
   | 预测分数 | 活性预测值（0-1），分数越高活性越强 |
   | 进度条 | 可视化分数大小，绿色=低，红色=高 |
   | 分子属性 | MW、LogP、TPSA、HBD、HBA、可旋转键数 |
   | Lipinski评估 | 五规则逐条评估，✓=通过，✗=不通过 |

#### Lipinski五规则说明

| 规则 | 阈值 | 含义 |
|------|------|------|
| 分子量 (MW) | ≤500 Da | 有利于口服吸收 |
| 脂水分配系数 (LogP) | ≤5 | 适当的脂溶性 |
| 氢键供体 (HBD) | ≤5 | 影响膜透过性 |
| 氢键受体 (HBA) | ≤10 | 影响膜透过性 |
| 可旋转键数 | ≤10 | 影响构象灵活性 |

---

### 3.2 批量筛选

**功能路径**：首页 → 批量筛选

#### 操作步骤

1. **准备数据**

   **方式一：上传CSV文件**（推荐）
   
   CSV文件格式要求：
   ```csv
   smiles,name
   CC(=O)OC1=CC=CC=C1C(=O)O,Aspirin
   CN1C=NC2=C1C(=O)N(C(=O)N2C)C,Caffeine
   CCO,Ethanol
   ```
   
   - 必须包含SMILES列（列名可自定义）
   - 支持拖拽上传或点击选择文件
   - 文件大小限制：200MB
   
   **方式二：手动输入**
   
   点击「或手动输入SMILES列表」展开输入框，每行一个SMILES：
   ```
   CC(=O)OC1=CC=CC=C1C(=O)O
   CN1C=NC2=C1C(=O)N(C(=O)N2C)C
   CCO
   ```

2. **配置筛选参数**

   | 参数 | 说明 | 默认值 |
   |------|------|--------|
   | SMILES列 | 选择CSV中的SMILES列名 | 自动检测 |
   | Top-K候选数 | 筛选返回的分子数量 | 10 |
   | 分数越小越好 | 是否升序排列（针对抑制型靶点） | 否 |
   | Lipinski过滤 | 是否只保留符合五规则的分子 | 是 |

3. **开始筛选**
   - 点击「🔬 开始筛选」按钮
   - 大批量数据可能需要较长时间

4. **查看筛选结果**

   **结果表格**
   
   | 列名 | 说明 |
   |------|------|
   | smiles | 分子SMILES |
   | score | 预测活性分数 |
   | MolecularWeight | 分子量（红色=超标） |
   | LogP | 脂水分配系数 |
   | TPSA | 拓扑极性表面积 |
   | NumHDonors | 氢键供体数 |
   | NumHAcceptors | 氢键受体数 |
   | NumAtoms | 原子总数 |
   | NumHeavyAtoms | 重原子数 |
   | NumRotatableBonds | 可旋转键数 |
   | NumAromaticRings | 芳香环数 |

   **功能按钮**
   - 点击列标题可排序
   - 点击「📥 下载结果CSV」导出筛选结果
   - 下方显示Top 6候选分子的2D结构图

---

## 4. API 接口说明

### 4.1 单分子预测

**POST** `/predict`

请求体：
```json
{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O"
}
```

响应：
```json
{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O",
  "score": 0.6990,
  "properties": {
    "MolecularWeight": 180.16,
    "LogP": 1.19,
    "TPSA": 63.60,
    "NumHDonors": 1,
    "NumHAcceptors": 4,
    "NumRotatableBonds": 3,
    "NumAromaticRings": 1
  },
  "lipinski": {
    "mw_ok": true,
    "logp_ok": true,
    "hbd_ok": true,
    "hba_ok": true,
    "rotatable_ok": true,
    "passes_all": true
  }
}
```

### 4.2 批量筛选

**POST** `/screen`

请求体：
```json
{
  "smiles_list": ["CC(=O)OC1=CC=CC=C1C(=O)O", "CN1C=NC2=C1C(=O)N(C(=O)N2C)C"],
  "top_k": 10,
  "ascending": false,
  "apply_lipinski": true
}
```

响应：
```json
{
  "total_input": 924,
  "total_screened": 10,
  "results": [
    {
      "rank": 1,
      "smiles": "...",
      "score": 0.95,
      "properties": {...}
    }
  ]
}
```

### 4.3 分子图像生成

**GET** `/molecule/image?smiles={SMILES}&width=300&height=300`

返回：PNG图像

### 4.4 系统信息

**GET** `/system/info`

返回模型状态、设备信息、版本等。

---

## 5. 常见问题与解决方案

### Q1: 前端页面无法连接后端

**症状**：预测时提示"Network Error"

**解决方案**：
1. 确保后端服务已启动并在8000端口运行
2. 检查浏览器控制台是否有CORS错误
3. 确认后端启用了CORS中间件

### Q2: SMILES无法解析

**症状**：提示"Invalid SMILES string"

**解决方案**：
1. 检查SMILES语法是否正确
2. 使用在线工具验证（如 https://cactus.nci.nih.gov/）
3. 确保没有多余的空格或换行

### Q3: CSV文件无法解析

**症状**：上传后数据为空

**解决方案**：
1. 确保文件编码为UTF-8
2. 检查是否有表头行
3. 确保使用英文逗号分隔
4. 检查SMILES列名是否正确

### Q4: 模型加载失败

**症状**：后端启动时报错"Model loading failed"

**解决方案**：
1. 确保`model/best_model.pt`文件存在
2. 检查PyTorch版本兼容性
3. 确保GPU驱动（如使用CUDA）正常

### Q5: 预测分数异常

**症状**：所有分子分数都很接近或为0/1

**解决方案**：
1. 检查模型是否正确加载
2. 确认输入分子在模型训练域内
3. 检查分子指纹生成是否正常

---

## 附录：快速启动命令

```bash
# 一键启动（需要两个终端窗口）

# 终端1 - 后端
cd d:\OneDrive\桌面\cursor\drug\backend
python -m uvicorn app.main:app --reload --port 8000

# 终端2 - 前端
cd d:\OneDrive\桌面\cursor\drug\frontend
npm run dev
```

**访问地址**：http://localhost:5173

---

*文档版本：1.0 | 更新日期：2025年*
