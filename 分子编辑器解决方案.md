# 🎨 分子编辑器无法加载的解决方案

## 问题原因

外部Ketcher服务器 `lifescience.opensource.epam.com` 无法访问（可能被防火墙阻止或服务不可用）。

---

## ✅ 方案1：使用JSME编辑器（已实施）

**JSME** 是一个轻量级的纯JavaScript分子编辑器，从CDN加载，无需iframe。

### 优点
- ✅ 纯JavaScript，无需外部服务器
- ✅ 加载速度快
- ✅ 功能完整（绘制分子、生成SMILES）
- ✅ 已经集成到系统中

### 使用方法
1. 刷新页面后，分子编辑器会自动从 `jsme-editor.github.io` 加载
2. 如果CDN也无法访问，请使用"手动输入"标签页

---

## 🔄 方案2：本地部署Ketcher（推荐用于生产环境）

如果需要完全离线的解决方案：

### 步骤1：安装Ketcher

```bash
cd frontend
npm install ketcher-react ketcher-core
```

### 步骤2：创建本地Ketcher组件

创建 `frontend/src/components/LocalKetcherEditor.vue`：

```vue
<template>
  <div class="ketcher-wrapper">
    <div ref="ketcherContainer" style="height: 400px;"></div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { Editor } from 'ketcher-react';
import { StandaloneStructServiceProvider } from 'ketcher-standalone';

const ketcherContainer = ref<HTMLDivElement | null>(null);
let ketcherEditor: any = null;

onMounted(() => {
  const structServiceProvider = new StandaloneStructServiceProvider();
  
  if (ketcherContainer.value) {
    ketcherEditor = Editor.createEditor({
      structServiceProvider,
      errorHandler: (message: string) => console.error(message)
    });
  }
});

defineExpose({
  getSmiles: () => ketcherEditor?.getSmiles(),
  setSmiles: (smiles: string) => ketcherEditor?.setMolecule(smiles)
});
</script>
```

---

## 🌐 方案3：使用其他在线编辑器

### ChemDoodle Web

```bash
# 在 public/index.html 中添加
<script src="https://web.chemdoodle.com/install/ChemDoodleWeb.js"></script>
```

### MarvinJS（商业软件）

免费试用版可用于测试：
```
https://marvinjs-demo.chemaxon.com/latest/
```

---

## 📋 方案4：简化为纯文本输入（最简单）

如果编辑器都无法加载，可以简化为只保留"手动输入"模式：

### 修改 PredictView.vue

```vue
<!-- 移除编辑器Tab，只保留手动输入 -->
<div class="space-y-4">
  <label for="smiles" class="block text-sm font-medium text-gray-700 mb-1">
    输入SMILES字符串
  </label>
  <div class="relative">
    <input 
      type="text" 
      v-model="smilesInput"
      id="smiles" 
      class="block w-full px-4 py-3 rounded-lg border"
      placeholder="例如：CC(=O)OC1=CC=CC=C1C(=O)O"
    />
  </div>
  
  <!-- 提供外部工具链接 -->
  <div class="text-sm text-gray-500">
    💡 可以使用以下在线工具绘制分子：
    <a href="https://pubchem.ncbi.nlm.nih.gov/edit3/index.html" 
       target="_blank" 
       class="text-blue-600 underline ml-1">
      PubChem Sketcher
    </a>
  </div>
</div>
```

---

## 🎯 推荐方案

### 开发环境
✅ **方案1（JSME）** - 已实施，简单快速

### 生产环境
✅ **方案2（本地Ketcher）** - 完全离线，功能强大

### 网络受限环境
✅ **方案4（纯文本）** + 外部工具链接

---

## 🔍 测试当前实施的方案

1. 刷新浏览器页面
2. 进入"单分子预测"
3. 点击"分子编辑器"标签页
4. 等待JSME加载（约2-3秒）
5. 使用左侧工具栏绘制分子
6. 点击"获取SMILES"按钮

如果JSME也无法加载，请：
- 检查网络连接
- 使用"手动输入"标签页
- 或考虑实施方案2（本地部署）

---

## 📞 需要帮助？

如果上述方案都无法解决问题，可以：
1. 使用VPN访问外部CDN
2. 下载JSME到本地服务器
3. 完全移除编辑器功能，只使用文本输入
