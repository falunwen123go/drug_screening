# 🔬 药物虚拟筛选系统 - 完整功能说明文档

## 目录
1. [系统概述](#1-系统概述)
2. [核心功能详解](#2-核心功能详解)
3. [预测模型说明](#3-预测模型说明)
4. [药物相似性评估 (Lipinski五规则)](#4-药物相似性评估-lipinski五规则)
5. [API接口文档](#5-api接口文档)
6. [系统改进建议](#6-系统改进建议)
7. [快速启动指南](#7-快速启动指南)

---

## 1. 系统概述

### 1.1 系统简介

本系统是一个基于深度学习的**药物虚拟筛选平台**，用于辅助药物研发早期阶段的化合物筛选工作。系统能够：

- 🎯 **预测分子活性**：基于深度神经网络预测化合物的特定生物活性
- 📊 **批量筛选**：从大规模化合物库中快速筛选出候选药物
- 🧬 **类药性评估**：基于Lipinski五规则评估化合物的成药潜力
- 📈 **分子性质计算**：自动计算分子的理化性质

### 1.2 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端 (Vue 3 + TypeScript)                  │
│                    TailwindCSS + Vite                        │
│                    端口: 5173                                 │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTP API
┌─────────────────────────────────────────────────────────────┐
│                    后端 (FastAPI)                             │
│                    端口: 8000                                 │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐                │
│  │ 预测服务   │  │ 筛选服务   │  │ 分子服务   │                │
│  └───────────┘  └───────────┘  └───────────┘                │
├─────────────────────────────────────────────────────────────┤
│                深度学习推理引擎 (PyTorch)                       │
│                分子处理 (RDKit)                               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    预训练模型                                  │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │  bbbp_model.pth │  │  esol_model.pth │                   │
│  │  血脑屏障穿透性   │  │  水溶性预测      │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 核心功能详解

### 2.1 单分子预测

**功能描述**：对单个化合物进行活性预测和类药性评估。

**输入**：
- SMILES字符串（化合物的线性表示法）

**输出**：
- 预测分数（根据当前模型的预测值）
- 分子2D结构图
- 分子理化性质（MW、LogP、TPSA等）
- Lipinski五规则评估结果

**使用场景**：
- 单个先导化合物的快速评估
- 化合物结构优化后的性质验证
- 教学演示

### 2.2 批量筛选

**功能描述**：从化合物库中筛选出Top-K候选药物。

**输入**：
- CSV文件（包含SMILES列）或手动输入的SMILES列表
- 筛选参数：Top-K数量、排序方式、是否应用Lipinski过滤

**输出**：
- 排序后的候选化合物列表
- 每个化合物的预测分数和性质
- 可下载的CSV结果文件

**使用场景**：
- 虚拟筛选大规模化合物库
- 先导化合物发现
- 化合物库质量评估

### 2.3 模型切换

**功能描述**：动态切换不同的预测模型。

**支持模型**：
- `bbbp_model.pth` - 血脑屏障穿透性预测
- `esol_model.pth` - 水溶性预测

**API**：`POST /system/load_model`

---

## 3. 预测模型说明

### 3.1 BBBP模型 (bbbp_model.pth)

| 属性 | 说明 |
|------|------|
| **全称** | Blood-Brain Barrier Permeability |
| **中文名** | 血脑屏障穿透性预测 |
| **任务类型** | 二分类 (Binary Classification) |
| **预测目标** | 预测药物分子能否穿过血脑屏障 |
| **输出范围** | 0-1 (概率值) |
| **阈值** | 0.5 |
| **应用场景** | 中枢神经系统药物研发 |

**什么是血脑屏障？**

血脑屏障(BBB)是保护大脑的生理屏障，由脑毛细血管内皮细胞紧密连接构成。它能阻止大多数物质进入脑组织，但这也给中枢神经系统疾病（如阿尔茨海默病、帕金森病）的药物研发带来挑战。

**🎯 BBBP模型打分机制详解**：

```
输入: SMILES字符串
    ↓
Morgan指纹计算 (radius=2, bits=1024)
    ↓
MLP神经网络前向传播
    ↓
Sigmoid激活函数 → 输出概率值 p ∈ [0, 1]
    ↓
阈值判断: p > 0.5 → 高概率穿透
           p ≤ 0.5 → 低概率穿透
```

**打分计算公式**：
$$
\text{score} = \sigma(W \cdot x + b) = \frac{1}{1 + e^{-(W \cdot x + b)}}
$$

其中：
- $x$ 是分子的Morgan指纹向量 (1024维)
- $W$ 是神经网络的权重矩阵
- $b$ 是偏置向量
- $\sigma$ 是Sigmoid函数，将输出映射到(0,1)区间

**预测结果解读**：
- **分数 > 0.5**：高概率穿透血脑屏障 ✅
- **分数 ≤ 0.5**：低概率穿透血脑屏障 ⚠️
- **分数接近1.0**：模型非常确信该分子能穿透BBB
- **分数接近0.0**：模型非常确信该分子不能穿透BBB
- **分数接近0.5**：模型不确定，可能需要实验验证

### 3.2 ESOL模型 (esol_model.pth)

| 属性 | 说明 |
|------|------|
| **全称** | Estimated SOLubility |
| **中文名** | 水溶性预测 |
| **任务类型** | 回归 (Regression) |
| **预测目标** | 预测化合物在水中的溶解度 |
| **输出单位** | log mol/L |
| **阈值** | -3.0 (作为参考) |
| **应用场景** | 药物制剂开发、ADMET评估 |

**为什么水溶性重要？**

水溶性是药物ADMET（吸收、分布、代谢、排泄、毒性）性质中的关键参数：
- 影响药物的口服吸收
- 决定药物制剂的选择
- 与药物生物利用度密切相关

**🎯 ESOL模型打分机制详解**：

```
输入: SMILES字符串
    ↓
Morgan指纹计算 (radius=2, bits=1024)
    ↓
MLP神经网络前向传播
    ↓
直接输出回归值 (无激活函数)
    ↓
输出: log(溶解度) ∈ [-10, +2] log mol/L
```

**打分计算公式**：
$$
\text{score} = W \cdot x + b
$$

其中：
- $x$ 是分子的Morgan指纹向量 (1024维)
- $W$ 是神经网络的权重矩阵
- $b$ 是偏置向量
- 输出是实际的log溶解度值（没有激活函数）

**预测结果解读**：
| 溶解度 (log mol/L) | 分类 | 说明 |
|-------------------|------|------|
| > -1 | 高溶解性 | 溶解度很好 |
| -1 ~ -3 | 中等溶解性 | 可接受范围 |
| -3 ~ -5 | 低溶解性 | 可能需要特殊制剂 |
| < -5 | 极低溶解性 | 药物开发困难 |

**实际数值理解**：
- log mol/L = -2.0 表示溶解度约为 0.01 mol/L
- log mol/L = -4.0 表示溶解度约为 0.0001 mol/L

### 3.3 🔥 双模型预测（新功能）

系统现在支持**同时使用两个模型**进行预测，给出更全面的评估结果。

**为什么需要双模型预测？**

| 单模型预测 | 双模型预测 |
|-----------|-----------|
| 只关注一个性质 | 综合评估多个性质 |
| 可能遗漏重要信息 | 更全面的药物评估 |
| 适合单一目标优化 | 适合多目标药物筛选 |

**双模型预测API**：
```http
POST /predict/dual
Content-Type: application/json

{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O"
}
```

**响应示例**：
```json
{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O",
  "bbbp_result": {
    "model_name": "BBBP",
    "model_cn_name": "血脑屏障穿透性",
    "score": 0.6990,
    "label": "高概率穿透血脑屏障",
    "icon": "🧠",
    "unit": ""
  },
  "esol_result": {
    "model_name": "ESOL",
    "model_cn_name": "水溶性预测",
    "score": -2.15,
    "label": "中等溶解性",
    "icon": "💧",
    "unit": "log mol/L"
  },
  "properties": {...},
  "lipinski_passed": true
}
```

### 3.4 批量筛选的打分机制

#### 📊 单模型筛选模式

在单模型筛选模式下，系统使用**当前加载的模型**对所有分子进行预测，然后根据分数排序。

```
输入: N个SMILES分子
    ↓
使用当前模型预测每个分子的分数
    ↓
根据分数排序（升序或降序）
    ↓
可选: 应用Lipinski过滤器
    ↓
输出: Top-K候选分子
```

**排序规则**：
- **BBBP模型**: 默认降序排列（分数越高表示越容易穿透BBB）
- **ESOL模型**: 默认降序排列（分数越高表示溶解性越好）
- 用户可勾选"分数越小越好"来反转排序

#### 🔥 双模型筛选模式（新功能）

在双模型筛选模式下，系统**同时加载并使用两个模型**，为每个分子计算两个分数。

```
输入: N个SMILES分子
    ↓
使用BBBP模型预测 → bbbp_score
使用ESOL模型预测 → esol_score
    ↓
主排序: 按BBBP分数排序（CNS药物优先）
    ↓
可选: 应用Lipinski过滤器
    ↓
输出: Top-K候选分子（包含两个分数）
```

**⚠️ 重要说明**：
- 双模型模式下，**主排序依据是BBBP分数**（因为BBB穿透性对CNS药物更重要）
- ESOL分数作为附加信息显示，不参与排序
- 用户可以在结果表格中点击列头手动按不同列排序

### 3.5 模型架构

两个模型均采用 **DrugPredictorMLPv2** 架构：

```
输入层 (1024) → Morgan指纹
    ↓
全连接层 (256) + BatchNorm + ReLU + Dropout(0.5)
    ↓
全连接层 (128) + BatchNorm + ReLU + Dropout(0.5)
    ↓
全连接层 (64) + BatchNorm + ReLU + Dropout(0.5)
    ↓
输出层 (1) → Sigmoid (BBBP) / 直接输出 (ESOL)
```

### 3.6 常见问题解答

**Q: 为什么以前只能选择一个模型？**

A: 这是系统的早期设计限制。现在已经支持双模型预测，可以同时获得两个模型的预测结果。

**Q: 两个模型的分数可以综合吗？**

A: 两个模型的分数**不应该简单相加或平均**，因为：
1. 它们的量纲不同（BBBP是概率[0,1]，ESOL是log mol/L）
2. 它们衡量的是不同的性质
3. 正确做法是**分别参考**两个分数

**Q: 如何理解双模型筛选的结果？**

A: 理想的CNS药物候选分子应该：
- BBBP分数 > 0.5（能穿透血脑屏障）
- ESOL分数 > -3.0（有良好的水溶性）
- 符合Lipinski五规则

---

## 4. 药物相似性评估 (Lipinski五规则)

### 4.1 什么是Lipinski五规则？

**Lipinski五规则**（Rule of Five, RO5）由辉瑞公司的Christopher Lipinski于1997年提出，是评估化合物**口服生物利用度**的经验规则。

### 4.2 五条规则详解

| 规则 | 阈值 | 意义 |
|------|------|------|
| **分子量 (MW)** | ≤ 500 Da | 分子量过大不利于吸收 |
| **脂水分配系数 (LogP)** | ≤ 5 | 脂溶性过高影响溶解和分布 |
| **氢键供体 (HBD)** | ≤ 5 | 过多氢键供体影响膜渗透 |
| **氢键受体 (HBA)** | ≤ 10 | 过多氢键受体影响吸收 |
| **可旋转键 (RotBonds)** | ≤ 10 | 柔性过大影响构象稳定性 |

### 4.3 为什么需要类药性评估？

1. **早期筛选**：在药物发现早期排除不具有成药性的化合物
2. **降低风险**：减少后期临床失败的概率
3. **指导优化**：为化合物结构优化提供方向

### 4.4 局限性

- 规则是经验性的，有例外情况
- 不适用于所有类型的药物（如天然产物、大分子药物）
- 现代药物研发中常使用更复杂的评估标准

---

## 5. API接口文档

### 5.1 单分子预测

```http
POST /predict
Content-Type: application/json

{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O"
}
```

**响应**：
```json
{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O",
  "prediction": 0.6990,
  "prediction_label": "高概率穿透血脑屏障",
  "properties": {
    "MolecularWeight": 180.16,
    "LogP": 1.19,
    "TPSA": 63.60,
    "NumHDonors": 1,
    "NumHAcceptors": 4
  },
  "lipinski_passed": true,
  "model_info": {
    "name": "BBBP",
    "cn_name": "血脑屏障穿透性",
    "task_type": "binary",
    "icon": "🧠"
  }
}
```

### 5.2 双模型预测（新API）

```http
POST /predict/dual
Content-Type: application/json

{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O"
}
```

**响应**：
```json
{
  "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O",
  "bbbp_result": {
    "model_name": "BBBP",
    "model_cn_name": "血脑屏障穿透性",
    "score": 0.6990,
    "label": "高概率穿透血脑屏障",
    "icon": "🧠",
    "unit": ""
  },
  "esol_result": {
    "model_name": "ESOL",
    "model_cn_name": "水溶性预测",
    "score": -2.15,
    "label": "中等溶解性",
    "icon": "💧",
    "unit": "log mol/L"
  },
  "properties": {
    "MolecularWeight": 180.16,
    "LogP": 1.19,
    "TPSA": 63.60,
    "NumHDonors": 1,
    "NumHAcceptors": 4
  },
  "lipinski_passed": true,
  "status": "success"
}
```

### 5.3 批量筛选

```http
POST /screen
Content-Type: application/json

{
  "smiles_list": ["CC(=O)OC1=CC=CC=C1C(=O)O", "CCO"],
  "top_k": 10,
  "ascending": false,
  "apply_lipinski": true,
  "use_dual_model": true
}
```

**响应（双模型模式）**：
```json
{
  "total_input": 2,
  "total_screened": 2,
  "use_dual_model": true,
  "results": [
    {
      "rank": 1,
      "smiles": "CC(=O)OC1=CC=CC=C1C(=O)O",
      "score": 0.6990,
      "bbbp_score": 0.6990,
      "esol_score": -2.15,
      "properties": {...}
    }
  ]
}
```

### 5.4 模型切换

```http
POST /system/load_model
Content-Type: application/json

{
  "model_name": "esol_model.pth"
}
```

### 5.4 分子图像

```http
GET /molecule/image?smiles={SMILES}&width=300&height=300
```

返回PNG图像。

---

## 6. 系统改进建议

### 6.1 短期改进 (1-2周)

| 改进项 | 描述 | 优先级 |
|--------|------|--------|
| **模型选择器UI** | 在前端添加模型切换下拉框 | 高 |
| **历史记录** | 保存用户的预测历史 | 高 |
| **批量导出** | 支持导出为Excel/PDF格式 | 中 |
| **分子编辑器** | 集成分子绘图工具 | 中 |

### 6.2 中期改进 (1-3月)

| 改进项 | 描述 | 复杂度 |
|--------|------|--------|
| **更多预测模型** | 添加hERG毒性、CYP450抑制等模型 | 高 |
| **多任务预测** | 同时预测多个ADMET性质 | 高 |
| **相似性搜索** | 基于指纹的化合物相似性检索 | 中 |
| **分子聚类** | 对筛选结果进行化学空间聚类 | 中 |
| **可解释性** | 添加原子贡献可视化 | 高 |

### 6.3 长期改进 (3-6月)

| 改进项 | 描述 | 价值 |
|--------|------|------|
| **图神经网络** | 升级为GNN/GCN模型 | 提升预测精度 |
| **主动学习** | 支持用户反馈优化模型 | 持续改进 |
| **分子生成** | 集成生成式AI进行分子设计 | 创新功能 |
| **对接模块** | 添加分子对接预筛选 | 完整流程 |
| **数据库集成** | 对接ChEMBL、PubChem等 | 数据丰富 |

### 6.4 功能扩展建议

#### 6.4.1 ADMET预测面板
```
┌─────────────────────────────────────────────────┐
│               ADMET综合预测                      │
├─────────────────────────────────────────────────┤
│  吸收 (Absorption)                              │
│  ├── 水溶性 (ESOL): -2.3 ✅                     │
│  ├── Caco-2渗透性: 高 ✅                        │
│  └── P-gp底物: 否 ✅                            │
├─────────────────────────────────────────────────┤
│  分布 (Distribution)                            │
│  ├── BBB穿透: 高概率 ✅                         │
│  └── 血浆蛋白结合: 85% ⚠️                       │
├─────────────────────────────────────────────────┤
│  代谢 (Metabolism)                              │
│  ├── CYP2D6抑制: 否 ✅                          │
│  └── CYP3A4抑制: 是 ❌                          │
├─────────────────────────────────────────────────┤
│  毒性 (Toxicity)                                │
│  ├── hERG抑制: 低风险 ✅                        │
│  ├── AMES致突变: 阴性 ✅                        │
│  └── 肝毒性: 低风险 ✅                          │
└─────────────────────────────────────────────────┘
```

#### 6.4.2 化学空间可视化
- t-SNE/UMAP降维可视化
- 与已知药物的空间位置对比
- 交互式散点图探索

#### 6.4.3 报告生成
- 自动生成PDF筛选报告
- 包含分子图、性质表、预测结果
- 支持自定义模板

---

## 7. 快速启动指南

### 7.1 环境要求

- Python 3.8+
- Node.js 16+
- CUDA 11.x (可选，用于GPU加速)

### 7.2 启动后端

```bash
cd d:\OneDrive\桌面\cursor\drug\backend
conda activate drug_screen
python -m uvicorn app.main:app --reload --port 8000
```

### 7.3 启动前端

```bash
cd d:\OneDrive\桌面\cursor\drug\frontend
npm install  # 首次运行
npm run dev
```

### 7.4 访问系统

打开浏览器访问：**http://localhost:5173**

### 7.5 切换模型

通过API切换模型：

```bash
# 切换到ESOL模型
curl -X POST "http://localhost:8000/system/load_model" \
  -H "Content-Type: application/json" \
  -d '{"model_name": "esol_model.pth"}'

# 切换到BBBP模型
curl -X POST "http://localhost:8000/system/load_model" \
  -H "Content-Type: application/json" \
  -d '{"model_name": "bbbp_model.pth"}'
```

---

## 附录：常用SMILES示例

| 药物名称 | SMILES | 用途 |
|----------|--------|------|
| 阿司匹林 | `CC(=O)OC1=CC=CC=C1C(=O)O` | 解热镇痛 |
| 咖啡因 | `CN1C=NC2=C1C(=O)N(C(=O)N2C)C` | 中枢兴奋 |
| 布洛芬 | `CC(C)CC1=CC=C(C=C1)C(C)C(=O)O` | 抗炎镇痛 |
| 多巴胺 | `NCCc1ccc(O)c(O)c1` | 神经递质 |
| 青霉素G | `CC1(C)SC2C(NC(=O)Cc3ccccc3)C(=O)N2C1C(=O)O` | 抗生素 |
| 地西泮 | `CN1C(=O)CN=C(C2=CC=CC=C21)C3=CC=CC=C3Cl` | 镇静催眠 |

---

*文档版本：2.0*  
*更新日期：2025年12月25日*  
*作者：药物筛选系统开发团队*
